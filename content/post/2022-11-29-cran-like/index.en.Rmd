---
title: Make your own CRAN-like repository with Linux binary R packages
author: Tom Palmer
date: '2022-11-29'
slug: cran-like
categories:
  - Blog
tags:
  - R
  - CRAN
  - Linux
  - Ubuntu
subtitle: ''
summary: 'Make your own CRAN-like repository serving not only bundled source packages and Windows and macOS binary packages but also Linux binary packages.'
authors: []
lastmod: '2022-11-29T16:29:01Z'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---

```{r include=FALSE}
knitr::opts_chunk$set(collapse = TRUE,
                      fig.align = 'center')
```

## Introduction

CRAN is a fantastic resource, in particular because it provides binary packages for Windows and macOS (for both Intel and Apple Silicon Macs). Because there are so many Linux distributions it does not provide binary packages for Linux and so installing R packages on Linux can be slow as the bundled source packages need to be built on the user's machine.

Of course there are quite a few resources providing binary R packages for specific Linux distributions (including Michael Rutter's PPA for Ubuntu, and binary packages for Debian, and the R2U system which can use the BSPM.)

I will focus on the publicly available Posit (formerly RStudio) Package Manager which is a fantastic resource for two reasons, it provides

* CRAN snapshots (in a similar way to Microsoft's CRAN snapshots service)
* binary R packages for several Linux distributions (currently for an impressive 11 distros).

The aim of this is post is to show how the magic of distributing Linux binry packages is achieved.

## The structure of CRAN

In two excellent blog posts Marks Sellors describes how to make a CRAN-like repository.^[<https://blog.sellorm.com/2019/03/29/lifting-the-lid-on-cran/> and <https://blog.sellorm.com/2019/03/30/build-your-own-cran-like-repo/>] And there is an excellent package, [**miniCRAN**](https://cran.r-project.org/package=miniCRAN) to help do this, but I don't need to use this for the following explanation.

To host bundled source packages, i.e., package sources which have been run through `R CMD build` to make a `package_version.tar.gz` file for each package, we require the following directory structure (noting that the `latest` directory is optional, but allows you to add snapshot directories at a later date).
<!-- # brew install tree -->
<!-- tree ~/Documents/GitHub/cran/site -d -I '__linux__|bin' --noreport -->
```text
/mycran
└── latest
    └── src
        └── contrib
            └── 4.3.0
                └── Recommended
```

Assuming that you have some bundled source package `package_version.tar.gz` files, from say CRAN or built from your own package sources, we place those into the `.../src/contrib` directory. In that directory we then run 
```r
tools::write_PACKAGES()
```
which generates 3 additional files (`PACKAGES`, `PACKAGES.gz`, and `PACKAGES.rds`) which R will use to query what packages are available in our repository when its served on the web.

## Adding Windows and macOS binary R packages

To build binary R packages the bundled source version of the package, the `package_version.tar.gz` file needs to be run through `R CMD install --build`. On Windows this will generate a `package_version.zip` file, and a `package_version.tgz` file on macOS. Once we have generated some binary packages we need to know where to put them.

Since CRAN distributes binary packages for Windows and macOS we follow their directory structure, which is as follows.
<!-- brew install tree -->
<!-- tree ~/Documents/GitHub/cran/site -d -I '__linux__' --noreport -->
```text
/mycran
└── latest
    ├── bin
    │   ├── macosx
    │   │   ├── big-sur-arm64
    │   │   │   └── contrib
    │   │   │       └── 4.2
    │   │   └── contrib
    │   │       └── 4.2
    │   └── windows
    │       └── contrib
    │           └── 4.2
    └── src
        └── contrib
            └── 4.3.0
                └── Recommended
```
Noting that the current version of R is 4.2.2 (the relevant directory name with the minor version changes when R's minor version number changes), we place

* Windows binary packages into the `.../bin/windows/contrib/4.2/` directory.
* macOS x86_64 binary packages (for Macs with Intel processors) into the `.../bin/macosx/contrib/4.2/` directory.
* macOS arm64 binary packages (for Macs with Apple Silicon processors) into the `.../bin/macosx/big-sur-arm64/contrib/4.2/` directory.

We then run `tools::write_PACKAGES()` in each of these directories to generate the 3 `PACKAGES` files.

## Where to store and how to name Linux binary R packages?

CRAN does not distribute Linux binary packages and so there is no folder structure to copy.

However there is from the RStudio/Posit Package Manager, which achieves this in a very clever way.

On Linux when we build binary packages with `R CMD install --build .` they are generated with file names such as `pkgname_version_R_x86_64-pc-linux-gnu.tar.gz`. Posit rename these files to simply `pkgname_version.tar.gz`, which we remember is the same naming format as for bundled source packages. This is no coincidence.

They then place them in a parallel directory structure, called `./__linux__/distro-name/latest/`, with the same subdirectory structure as for CRAN's bundled source packages. Hence, `package_version.tar.gz` files of binary packages for say Ubuntu Focal Fossa are placed into the `.../__linux__/focal/latest/src/contrib/` directory and so the structure of our repository (well in fact our 2 parallel repositories) is now.
<!-- tree ~/Documents/GitHub/cran/site -d -I 'jammy' --noreport -->
```text
/mycran
├── __linux__
│   └── focal
│       └── latest
│           └── src
│               └── contrib
│                   └── 4.3.0
│                       └── Recommended
└── latest
    ├── bin
    │   ├── macosx
    │   │   ├── big-sur-arm64
    │   │   │   └── contrib
    │   │   │       └── 4.2
    │   │   └── contrib
    │   │       └── 4.2
    │   └── windows
    │       └── contrib
    │           └── 4.2
    └── src
        └── contrib
            └── 4.3.0
                └── Recommended
```
And again we the run `tools::write_PACKAGES()` in the `.../__linux__/distro-name/src/contrib` directory for each Linux distribution that we make a parallel directory structure for.

Once this folder structure is being served we can set our repository in R to `.../__linux__/focal/latest` and R will find the `package_version.tar.gz` files in the `...__linux__/focal/src/contrib/` directory.

It is worth noting that the `package_version.tar.gz` files within `__linux__/focal/latest/src/contrib` do not all have to be of binary packages. They can be either bundled source or binary packages (indeed they could of course be all bundle source packages). This is helpful if you haven't had time to build all your binary versions.

## Testing your CRAN-like repositories locally

You can either run a local webserver or use the `file://...` URL notation as your `repos` global options setting (set with `option(repos = c(CRAN = "..."))` or as the `repos` argument to `install.packages()`). Here's a screenshot of installing a binary package on Ubuntu Focal Fossa.

```{r echo=FALSE, fig.alt="Screenshot of testing a CRAN-like repository on Ubuntu Focal Fossa."}
knitr::include_graphics('img/cran-like-focal-example.png')
```

## Summary

In summary, making a CRAN-like repository is a question of putting the right files in the right directory structure. Linux binary packages can be distributed by using the same naming convention as for bundled source packages, and placing them in the same directory as for bundled source packages. And you can make parallel directory structures to distribute Windows and macOS binary packages and source packages alongside Linux binary packages.
