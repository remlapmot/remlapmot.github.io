---
title: Make your own CRAN-like repository with Linux binary R packages
author: Tom Palmer
date: '2022-11-29'
slug: cran-like
categories:
  - Blog
tags:
  - R
  - CRAN
  - Linux
  - Ubuntu
subtitle: ''
summary: 'Make your own CRAN-like repository serving not only bundled source packages and Windows and macOS binary packages but also Linux binary packages.'
authors: []
lastmod: '2022-11-29T16:29:01Z'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>CRAN is a fantastic resource, in particular because it provides binary packages for Windows and macOS (for both Intel and Apple Silicon Macs). Because there are so many Linux distributions it does not provide binary packages for Linux and so installing R packages on Linux can be slow as the bundled source packages need to be built on users machines.</p>
<p>Of course there are quite a few resources providing binary R packages for specific Linux distributions (including Michael Rutter’s PPA for Ubuntu, and binary packages for Debian, and the R2U system which can use the BSPM.)</p>
<p>I will focus on the publicly available Posit (formerly RStudio) Package Manager which is a fantastic resource for two reasons, it provides</p>
<ul>
<li>CRAN snapshots (in a similar way to Microsoft’s CRAN snapshots service)</li>
<li>binary R packages for several Linux distributions (currently for an impressive 11 distros).</li>
</ul>
<p>The aim of this is post is to show how the magic of distributing Linux binary packages is achieved.</p>
</div>
<div id="building-bundled-source-and-binary-packages" class="section level2">
<h2>Building bundled source and binary packages</h2>
<p>I will use an example of one of my own packages <strong>OneSampleMR</strong>. I am running RStudio server on Ubuntu Linux, Focal Fossa through Windows Subsystem for Linux.</p>
<p>The package sources are in a Git repository hosted on GitHub, <a href="https://github.com/remlapmot/OneSampleMR">here</a>. There is an <code>.Rproj</code> file, so we open that in RStudio as a project.</p>
<p>To build an R package we require all of its dependency packages are installed, so we install those with</p>
<pre class="r"><code>devtools::install_dev_deps()</code></pre>
<p>And of course if your package requires any system libraries those must be installed too.</p>
<p>The Build pane gives us two convenient options, which will build either the bundled source package or binary package through calls to <code>devtools::build()</code>.</p>
<p><img src="img/rstudio-build-pane-build-options.png" alt="Screenshot of build pane options for building bundled source and binary packages" style="display: block; margin: auto;" /></p>
<p>Clicking on both in turn we see the following.</p>
<p><img src="img/rstudio-build-source-package.png" alt="Screenshot of building a bundled source package in RStudio" style="display: block; margin: auto;" /></p>
<p><img src="img/rstudio-build-binary-package.png" alt="Screenshot of building a binary package in RStudio" style="display: block; margin: auto;" /></p>
<p>The bundled source package has been built as <code>OneSampleMR_0.1.2.tar.gz</code> and the binary package has been built as <code>OneSampleMR_0.1.2_R_x86_64-pc-linux-gnu.tar.gz</code>, and both files are in the directory above the project.</p>
<p>We can achieve the same output by making direct calls to <code>R CMD build</code> and <code>R CMD install --build</code> in a shell if preferred.</p>
<p>We can test that these install as follows.</p>
<p><img src="img/rstudio-install-source-package.png" alt="Screenshot of installing a bundled source package in RStudio" style="display: block; margin: auto;" /></p>
<p><img src="img/rstudio-install-binary-package.png" alt="Screenshot of installing a bundled source package in RStudio" style="display: block; margin: auto;" /></p>
</div>
<div id="cran-structure-for-bundled-source-package-files" class="section level2">
<h2>CRAN structure for bundled source package files</h2>
<p>In two excellent blog posts Marks Sellors describes how to make a CRAN-like repository.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> And there is an excellent package, <a href="https://cran.r-project.org/package=miniCRAN"><strong>miniCRAN</strong></a> to help do this, but I don’t need to use this for the following explanation.</p>
<p>To host bundled source packages, such as our <code>OneSampleMR_0.1.2.tar.gz</code> file, we require the following directory structure (noting that the <code>latest</code> directory is optional, but allows us to add snapshot directories).
<!-- # brew install tree -->
<!-- tree ~/Documents/GitHub/cran/site -d -I '__linux__|bin' --noreport --></p>
<pre class="text"><code>/mycran
└── latest
    └── src
        └── contrib
            └── 4.3.0
                └── Recommended</code></pre>
<p>Specifically, we place the <code>.tar.gz</code> files into the <code>.../src/contrib</code> directory. And in that directory we then run</p>
<pre class="r"><code>tools::write_PACKAGES()</code></pre>
<p>That generates 3 additional files (<code>PACKAGES</code>, <code>PACKAGES.gz</code>, and <code>PACKAGES.rds</code>) which R will use to query what packages are available in our repository when its served on the web.</p>
</div>
<div id="adding-windows-and-macos-binary-r-packages" class="section level2">
<h2>Adding Windows and macOS binary R packages</h2>
<p>We saw above how to build a binary Linux package. The same process, when repeated on Windows will generate a file called <code>package_version.zip</code> and <code>package_version.tgz</code> on macOS (on Macs with both Intel and Apple Silicon processors).</p>
<p>Assuming that we have some of these files we need to know where to put them. Since CRAN distributes binary packages for Windows and macOS we follow their directory structure, which is as follows.
<!-- brew install tree -->
<!-- tree ~/Documents/GitHub/cran/site -d -I '__linux__' --noreport --></p>
<pre class="text"><code>/mycran
└── latest
    ├── bin
    │   ├── macosx
    │   │   ├── big-sur-arm64
    │   │   │   └── contrib
    │   │   │       └── 4.2
    │   │   └── contrib
    │   │       └── 4.2
    │   └── windows
    │       └── contrib
    │           └── 4.2
    └── src
        └── contrib
            └── 4.3.0
                └── Recommended</code></pre>
<p>Noting that the current version of R is 4.2.2 and that the relevant directory name with the minor version number changes when R’s current minor version number changes, we place</p>
<ul>
<li>macOS arm64 binary packages (for Macs with Apple Silicon processors) into the <code>.../bin/macosx/big-sur-arm64/contrib/4.2/</code> directory</li>
<li>macOS x86_64 binary packages (for Macs with Intel processors) into the <code>.../bin/macosx/contrib/4.2/</code> directory, and</li>
<li>Windows binary packages into the <code>.../bin/windows/contrib/4.2/</code> directory.</li>
</ul>
<p>We then run <code>tools::write_PACKAGES()</code> in each of these directories to generate the 3 <code>PACKAGES</code> files.</p>
</div>
<div id="where-to-store-and-how-to-name-linux-binary-r-packages" class="section level2">
<h2>Where to store and how to name Linux binary R packages?</h2>
<p>CRAN does not distribute Linux binary packages and so there is no folder structure from them to copy.</p>
<p>However there is from the Posit Package Manager, which achieves this in a very clever way.</p>
<p>We saw above that on Linux bundled source packages have filenames of the form <code>package_version.tar.gz</code> whereas the binary package filenames are of the form <code>pkgname_version_R_x86_64-pc-linux-gnu.tar.gz</code> (note the text after <code>package_version_</code> maybe different depending on your machine and distro).</p>
<p>To distribute the Linux binary packages Posit create a parallel directory structure, which takes the same form as for the bundled source packages. In the case of Ubuntu Focal Fossa this is <code>__linux__/focal/latest/src/contrib</code>.</p>
<p>They then rename the <code>pkgname_version_R_x86_64-pc-linux-gnu.tar.gz</code> files to the same form as the bundled source package files, i.e., <code>pkgname_version.tar.gz</code>. And they put them in this new <code>contrib</code> directory.</p>
<p>The structure of our repository (well in fact our 2 parallel repositories) is now.
<!-- tree ~/Documents/GitHub/cran/site -d -I 'jammy' --noreport --></p>
<pre class="text"><code>/mycran
├── __linux__
│   └── focal
│       └── latest
│           └── src
│               └── contrib
│                   └── 4.3.0
│                       └── Recommended
└── latest
    ├── bin
    │   ├── macosx
    │   │   ├── big-sur-arm64
    │   │   │   └── contrib
    │   │   │       └── 4.2
    │   │   └── contrib
    │   │       └── 4.2
    │   └── windows
    │       └── contrib
    │           └── 4.2
    └── src
        └── contrib
            └── 4.3.0
                └── Recommended</code></pre>
<p>And again we then run <code>tools::write_PACKAGES()</code> in the <code>.../__linux__/distro-name/src/contrib</code> directory for each Linux distribution that we make a parallel directory structure for.</p>
<p>Once this folder structure is being served we can set our repository in R to <code>.../__linux__/focal/latest</code> and R will find the binary package <code>package_version.tar.gz</code> files in the <code>...__linux__/focal/src/contrib/</code> directory.</p>
<p>It is worth noting that the <code>package_version.tar.gz</code> files within <code>__linux__/focal/latest/src/contrib</code> do not all have to be of binary packages. They can be either bundled source or binary packages. Indeed they could of course be all bundled source packages. This is helpful if you haven’t had time to build all your binary package files yet.</p>
</div>
<div id="testing-your-cran-like-repositories-locally" class="section level2">
<h2>Testing your CRAN-like repositories locally</h2>
<p>You can either run a local web server or use the <code>file://...</code> URL notation as your <code>repos</code> global options setting (set with <code>option(repos = c(CRAN = "..."))</code> or as the <code>repos</code> argument to <code>install.packages()</code>).</p>
<p>Here’s a screenshot of installing a binary package on Ubuntu Focal Fossa using the <code>file://</code> notation.
<img src="img/cran-like-focal-example.png" alt="Screenshot of testing a CRAN-like repository on Ubuntu Focal Fossa." style="display: block; margin: auto;" /></p>
</div>
<div id="summary" class="section level2">
<h2>Summary</h2>
<p>We have taken a look at the structure of a CRAN-like repository and how to build bundled source and binary package files. We then saw the trick for distributing Linux binary packages is to make a parallel directory with the same structure as for bundled source packages and that we need to give the binary package files the same filename format as those of the bundled source package files.</p>
</div>
<div class="footnotes footnotes-end-of-document">
<hr />
<ol>
<li id="fn1"><p><a href="https://blog.sellorm.com/2019/03/29/lifting-the-lid-on-cran/" class="uri">https://blog.sellorm.com/2019/03/29/lifting-the-lid-on-cran/</a> and <a href="https://blog.sellorm.com/2019/03/30/build-your-own-cran-like-repo/" class="uri">https://blog.sellorm.com/2019/03/30/build-your-own-cran-like-repo/</a><a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
